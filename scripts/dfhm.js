// Generated by CoffeeScript 1.3.3
(function() {
  var $, alertBox, clearWorldState, determineSize, getActiveField, getDimensions, getFieldRenderer, init, markFieldAsPopulated, onClearClick, onDimensionChange, onExportClick, onFileSelected, onImageLoaded, onOffsetChange, onRatioChange, regenerateAll, render, setActiveField, setOverrides, upcase, worldState;

  $ = jQuery;

  window.ratios = {
    elevation: 1.56863,
    temperature: 0.19608,
    rainfall: 0.39215,
    drainage: 0.39215,
    savagery: 0.39215,
    volcanicity: 0.39215
  };

  window.offsets = {
    elevation: 0,
    temperature: 25,
    rainfall: 0,
    drainage: 0,
    savagery: 0,
    volcanicity: 0
  };

  worldState = {
    elevation: {
      image: false,
      data: false,
      offset: false,
      ratio: false
    },
    temperature: {
      image: false,
      data: false,
      offset: false,
      ratio: false
    },
    rainfall: {
      image: false,
      data: false,
      offset: false,
      ratio: false
    },
    drainage: {
      image: false,
      data: false,
      offset: false,
      ratio: false
    },
    savagery: {
      image: false,
      data: false,
      offset: false,
      ratio: false
    },
    volcanicity: {
      image: false,
      data: false,
      offset: false,
      ratio: false
    }
  };

  onClearClick = function(event) {
    event.preventDefault();
    return clearWorldState();
  };

  onExportClick = function(event) {
    var height, width, _ref;
    _ref = getDimensions(), width = _ref.width, height = _ref.height;
    return $('#output-text').text(DFHMExport["export"](width, height, determineSize(), worldState));
  };

  determineSize = function() {
    var height, smallest, width, _ref;
    _ref = getDimensions(), width = _ref.width, height = _ref.height;
    smallest = Math.min(parseInt(width, 10), parseInt(height, 10));
    switch (smallest) {
      case 17:
        return 'boilerplateTiny';
      case 33:
        return 'boilerplateSmaller';
      case 65:
        return 'boilerplateSmall';
      case 129:
        return 'boilerplateMedium';
      case 257:
        return 'boilerplateLarge';
    }
  };

  onImageLoaded = function(event, stateField) {
    var dummyImage, height, width, _ref;
    _ref = getDimensions(), width = _ref.width, height = _ref.height;
    dummyImage = new Image();
    dummyImage.onload = function() {
      worldState[stateField].image = dummyImage;
      worldState[stateField].data = DFHMImport.toHeightValue(dummyImage, width, height, stateField, worldState[stateField].ratio, worldState[stateField].offset);
      markFieldAsPopulated(stateField);
      return render(stateField);
    };
    return dummyImage.src = event.target.result;
  };

  onFileSelected = function(event) {
    var activeField, file, reader;
    if (event.target.files[0]) {
      file = event.target.files[0];
      if (file.type.match("image.*")) {
        reader = new FileReader();
        activeField = getActiveField();
        reader.onload = function(event) {
          return onImageLoaded(event, activeField);
        };
        return reader.readAsDataURL(file);
      } else {
        return alertBox("error", "This is not a recognised image", "- you might want to try opening it in a graphics editor to check it's okay.");
      }
    }
  };

  markFieldAsPopulated = function(field) {
    return getFieldRenderer(field).children('a').html(upcase(field) + ' &#10003;');
  };

  getFieldRenderer = function(field) {
    return $('li', '#heightmaps').filter(function(index) {
      return $(this).data('type') === field;
    });
  };

  setActiveField = function(field) {
    var height, width, _ref;
    field = $(field);
    field.addClass('active').siblings().removeClass('active');
    _ref = getDimensions(), width = _ref.width, height = _ref.height;
    setOverrides(worldState[field.data('type')].ratio, worldState[field.data('type')].offset);
    return render(field.data('type'));
  };

  getActiveField = function() {
    return $('#heightmaps').children('li.active').data('type');
  };

  getDimensions = function() {
    var dimensions;
    return dimensions = {
      width: $('#dropdown-width').find('.master-label').text(),
      height: $('#dropdown-height').find('.master-label').text()
    };
  };

  clearWorldState = function() {
    var elementName, elementVal, optionName, optionVal;
    for (elementName in worldState) {
      elementVal = worldState[elementName];
      for (optionName in elementVal) {
        optionVal = elementVal[optionName];
        worldState[elementName][optionName] = false;
      }
    }
    $('#heightmaps').children('.hm-option').each(function(index, item) {
      item = $(item);
      return item.children('a').html(upcase(item.data('type')));
    });
    DFHMPreview.clear();
    $('#output-text').val('');
    return setOverrides(false, false);
  };

  onDimensionChange = function(event) {
    var btnGroup, value;
    event.preventDefault();
    value = $(event.target);
    btnGroup = value.parents('.btn-group');
    btnGroup.find('.master-label').text(value.text());
    return regenerateAll();
  };

  onRatioChange = function(event) {
    event.preventDefault();
    worldState[getActiveField()].ratio = $(event.target).val();
    return regenerateAll();
  };

  onOffsetChange = function(event) {
    event.preventDefault();
    worldState[getActiveField()].offset = $(event.target).val();
    return regenerateAll();
  };

  regenerateAll = function() {
    var element, height, stateField, width, _ref;
    _ref = getDimensions(), width = _ref.width, height = _ref.height;
    for (stateField in worldState) {
      element = worldState[stateField];
      if (element.image !== false) {
        element.data = DFHMImport.toHeightValue(element.image, width, height, stateField, element.ratio, element.offset);
      }
    }
    return render(getActiveField());
  };

  render = function(activeField) {
    var height, width, _ref;
    _ref = getDimensions(), width = _ref.width, height = _ref.height;
    if (activeField === 'elevation') {
      return DFHMPreview.renderElevation(worldState[activeField].data, width, height);
    } else {
      return DFHMPreview.renderOther(worldState[activeField].data, worldState['elevation'].data, width, height);
    }
  };

  upcase = function(string) {
    return string.charAt(0).toUpperCase() + string.substr(1);
  };

  alertBox = function(type, highlight, text) {
    return $('#alerts').prepend("<div class=\"alert alert-" + type + "\"><a class=\"close\" data-dismiss=\"alert\" href=\"#\">x</a><strong>" + highlight + "</strong> " + text + "</div>");
  };

  setOverrides = function(ratio, offset) {
    if (offset !== false) {
      $('#offset').val(offset);
    } else {
      $('#offset').val('');
    }
    if (ratio !== false) {
      return $('#ratio').val(ratio);
    } else {
      return $('#ratio').val('');
    }
  };

  init = function() {
    if (window.File && window.FileReader) {
      $('#image-loader').change(onFileSelected);
      $('#offset').change(onOffsetChange);
      $('#ratio').change(onRatioChange);
      $('#dropdown-height, #dropdown-width').children('.dropdown-menu').find('a').click(onDimensionChange);
      $('a', '#heightmaps').click(function(event) {
        event.preventDefault();
        return setActiveField($(event.target).parent('li'));
      });
      $('#clear').click(onClearClick);
      $('#export').click(onExportClick);
      $('#output-text').focus(function() {
        return $(this).select();
      });
      alertBox("info", "Hi there!", "To get generating heightmaps, pick a map size, select a field, and import some images! The preview box will update to show you\nwhat the map will look like - feel free to change some of the advanced variables to get closer to what you want. When you're done, hit Export, and copy the wall of text into data/init/world_gen.txt");
      return clearWorldState();
    } else {
      return alertBox("error", "Uh oh", "- your browser doesn't support features that this app requires! Please switch to somethign more modern and we can get on with it.");
    }
  };

  $(document).ready(init);

}).call(this);
