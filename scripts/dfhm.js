// Generated by CoffeeScript 1.3.3
(function() {
  var $, canvas, init, onFileSelected, onImageLoaded, pixelToGreyscale, toGreyscale;

  $ = jQuery;

  canvas = null;

  pixelToGreyscale = function(r, g, b) {
    return (r * 0.299) + (g * 0.587) + (b * 0.114);
  };

  toGreyscale = function(ctx) {
    var i, imageData, length, _fn, _i;
    imageData = ctx.getImageData(0, 0, 300, 300);
    length = imageData.data.length;
    _fn = function(i) {
      var brightness;
      brightness = pixelToGreyscale(imageData.data[i], imageData.data[i + 1], imageData.data[i + 2]);
      imageData.data[i] = imageData.data[i + 1] = imageData.data[i + 2] = brightness;
      return imageData.data[i + 3] = 255;
    };
    for (i = _i = 0; _i <= length; i = _i += 4) {
      _fn(i);
    }
    return ctx.putImageData(imageData, 0, 0);
  };

  onImageLoaded = function(event) {
    var dummyImage;
    dummyImage = new Image();
    dummyImage.onload = function() {
      var ctx;
      ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, 300, 300);
      ctx.drawImage(dummyImage, 0, 0, 300, 300);
      return toGreyscale(ctx);
    };
    return dummyImage.src = event.target.result;
  };

  onFileSelected = function(event) {
    var file, reader;
    if (event.target.files[0]) {
      file = event.target.files[0];
      if (file.type.match("image.*")) {
        reader = new FileReader();
        reader.onload = onImageLoaded;
        return reader.readAsDataURL(file);
      } else {
        return alert("Not an image");
      }
    }
  };

  init = function() {
    if (window.File && window.FileReader) {
      $('#test-loader').change(onFileSelected);
      return canvas = $('#output')[0];
    } else {
      return alert("noes");
    }
  };

  $(document).ready(init);

}).call(this);
